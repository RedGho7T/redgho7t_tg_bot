package ru.redgho7t.telegrambot.service;

import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;

import java.io.BufferedReader;
import java.io.InputStreamReader;
import java.net.HttpURLConnection;
import java.net.URL;
import java.nio.charset.StandardCharsets;
import java.util.Arrays;
import java.util.List;
import java.util.Random;

/**
 * –°–µ—Ä–≤–∏—Å –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è —Å–ª—É—á–∞–π–Ω—ã—Ö —Ä—É—Å—Å–∫–∏—Ö –∞–Ω–µ–∫–¥–æ—Ç–æ–≤ —Å —Ä–µ–∞–ª—å–Ω—ã–º–∏ API
 */
@Service
public class JokeService {

    private static final Logger logger = LoggerFactory.getLogger(JokeService.class);
    private final Random random = new Random();

    // –õ–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ —Ä—É—Å—Å–∫–∏—Ö –∞–Ω–µ–∫–¥–æ—Ç–æ–≤ (fallback)
    private final List<String> localJokes = Arrays.asList(
            "‚Äî –î–æ–∫—Ç–æ—Ä, –º–µ–Ω—è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –º—É—á–∞—é—Ç –∫–æ—à–º–∞—Ä—ã –ø—Ä–æ —Ñ—É—Ç–±–æ–ª!\n‚Äî –ü—Ä–∏–Ω–∏–º–∞–π—Ç–µ —ç—Ç–∏ —Ç–∞–±–ª–µ—Ç–∫–∏ –ø–µ—Ä–µ–¥ —Å–Ω–æ–º.\n‚Äî –ê —ç—Ç–æ –ø–æ–º–æ–∂–µ—Ç?\n‚Äî –ù–µ –∑–Ω–∞—é, –Ω–æ –ê—Ä—à–∞–≤–∏–Ω –ø—Ä–∏–Ω–∏–º–∞–ª.",

            "–í—Å—Ç—Ä–µ—á–∞—é—Ç—Å—è –¥–≤–∞ –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç–∞:\n‚Äî –ü—Ä–∏–≤–µ—Ç! –ö–∞–∫ –¥–µ–ª–∞? –ö–∞–∫ –∂–µ–Ω–∞?\n‚Äî –°–ø–∞—Å–∏–±–æ, –æ—Ç–∫–∞—Ç–∏–ª—Å—è –Ω–∞ –ø—Ä–µ–¥—ã–¥—É—â—É—é –≤–µ—Ä—Å–∏—é.",

            "–û–±—ä—è–≤–ª–µ–Ω–∏–µ: \"–ü—Ä–æ–¥–∞–º –≥–∞—Ä–∞–∂ –≤ —Å–≤—è–∑–∏ —Å –ø–æ–∫—É–ø–∫–æ–π –∫–≤–∞—Ä—Ç–∏—Ä—ã. –ì–∞—Ä–∞–∂ –Ω–∞—Ö–æ–¥–∏—Ç—Å—è –≤ —Å–ø–∞–ª—å–Ω–æ–º —Ä–∞–π–æ–Ω–µ.\"",

            "‚Äî –ü–æ—á–µ–º—É —É —Ç–µ–±—è –∂–µ–Ω–∞ —Ç–∞–∫–∞—è –Ω–µ—Ä–≤–Ω–∞—è?\n‚Äî –î–∞ —è —Å–∞–º –Ω–µ –ø–æ–Ω–∏–º–∞—é. –í—á–µ—Ä–∞ –ø—Ä–∏—Ö–æ–∂—É –¥–æ–º–æ–π –≤ 4 —É—Ç—Ä–∞, –∞ –æ–Ω–∞ –º–Ω–µ —É—Å—Ç—Ä–∞–∏–≤–∞–µ—Ç —Å—Ü–µ–Ω—É, —á—Ç–æ —è —è–∫–æ–±—ã –ø—Ä–æ–ø–∞–ª –Ω–∞ —Ç—Ä–∏ –¥–Ω—è.",

            "–•–æ—Ä–æ—à–æ –±—ã—Ç—å –ø–µ—Å—Å–∏–º–∏—Å—Ç–æ–º. –õ–∏–±–æ —Ç—ã –ø—Ä–∞–≤, –ª–∏–±–æ –ø—Ä–∏—è—Ç–Ω–æ —É–¥–∏–≤–ª–µ–Ω.",

            "‚Äî –ê–ª–ª–æ, —ç—Ç–æ —Å–ª—É–∂–±–∞ –∑–Ω–∞–∫–æ–º—Å—Ç–≤?\n‚Äî –î–∞.\n‚Äî –ê –ø—Ä–∞–≤–¥–∞, —á—Ç–æ —É –≤–∞—Å –µ—Å—Ç—å –¥–µ–≤—É—à–∫–∞, –∫–æ—Ç–æ—Ä–∞—è –∏—â–µ—Ç –º—É–∂—á–∏–Ω—É —Å –∫–≤–∞—Ä—Ç–∏—Ä–æ–π –∏ –º–∞—à–∏–Ω–æ–π?\n‚Äî –î–∞, –ø—Ä–∞–≤–¥–∞.\n‚Äî –ê –º–æ–∂–µ—Ç–µ –¥–∞—Ç—å –µ—ë —Ç–µ–ª–µ—Ñ–æ–Ω?\n‚Äî –ê —É –≤–∞—Å –µ—Å—Ç—å –∫–≤–∞—Ä—Ç–∏—Ä–∞ –∏ –º–∞—à–∏–Ω–∞?\n‚Äî –ù–µ—Ç.\n‚Äî –¢–æ–≥–¥–∞ –∑–∞—á–µ–º –≤–∞–º –µ—ë —Ç–µ–ª–µ—Ñ–æ–Ω?\n‚Äî –•–æ—á—É —Å –Ω–µ–π –ø–æ–¥—Ä—É–∂–∏—Ç—å—Å—è. –£ –Ω–∞—Å –º–Ω–æ–≥–æ –æ–±—â–µ–≥–æ.",

            "–í—Å—Ç—Ä–µ—Ç–∏–ª–∏—Å—å –¥–≤–∞ –±–∏–∑–Ω–µ—Å–º–µ–Ω–∞:\n‚Äî –ö–∞–∫ –¥–µ–ª–∞?\n‚Äî –î–∞ –≤ –ø–æ—Å–ª–µ–¥–Ω–µ–µ –≤—Ä–µ–º—è —Ö—É–∂–µ –Ω–µ –ø—Ä–∏–¥—É–º–∞–µ—à—å. –í—á–µ—Ä–∞ –∂–µ–Ω–∞ –≤—ã–∏–≥—Ä–∞–ª–∞ –≤ –ª–æ—Ç–µ—Ä–µ—é –º–∏–ª–ª–∏–æ–Ω –¥–æ–ª–ª–∞—Ä–æ–≤...\n‚Äî –¢—ã —á—Ç–æ, —Å —É–º–∞ —Å–æ—à—ë–ª? –≠—Ç–æ –∂–µ –∑–¥–æ—Ä–æ–≤–æ!\n‚Äî –î–∞, –Ω–æ –æ–Ω–∞ –µ—â—ë –Ω–µ –∑–Ω–∞–µ—Ç, —á—Ç–æ –º—ã —Ä–∞–∑–≤–µ–ª–∏—Å—å –¥–≤–∞ –¥–Ω—è –Ω–∞–∑–∞–¥!",

            "–ò–¥—ë—Ç –º—É–∂–∏–∫ –ø–æ –ø—É—Å—Ç—ã–Ω–µ, –≤–∏–¥–∏—Ç ‚Äî –ª–µ–∂–∏—Ç –ª–∞–º–ø–∞. –ü–æ—Ç—ë—Ä, –≤—ã–ª–µ–∑–∞–µ—Ç –¥–∂–∏–Ω–Ω:\n‚Äî –ò—Å–ø–æ–ª–Ω—é —Ç—Ä–∏ —Ç–≤–æ–∏—Ö –∂–µ–ª–∞–Ω–∏—è!\n‚Äî –•–æ—á—É –±—ã—Ç—å —Å–∞–º—ã–º –±–æ–≥–∞—Ç—ã–º!\n‚Äî –ì–æ—Ç–æ–≤–æ!\n‚Äî –•–æ—á—É –±—ã—Ç—å —Å–∞–º—ã–º —É–º–Ω—ã–º!\n‚Äî –ì–æ—Ç–æ–≤–æ!\n‚Äî –•–æ—á—É –±—ã—Ç—å —Å–∞–º—ã–º –∫—Ä–∞—Å–∏–≤—ã–º!\n‚Äî –ì–æ—Ç–æ–≤–æ!\n–ü—Ä–µ–≤—Ä–∞—â–∞–µ—Ç—Å—è –º—É–∂–∏–∫ –≤ –∂–µ–Ω—â–∏–Ω—É.",

            "‚Äî –î–æ—Ä–æ–≥–æ–π, –∞ –ø–æ–º–Ω–∏—à—å, —Ç—ã –æ–±–µ—â–∞–ª –∂–µ–Ω–∏—Ç—å—Å—è –Ω–∞ —Å–∞–º–æ–π –∫—Ä–∞—Å–∏–≤–æ–π –¥–µ–≤—É—à–∫–µ –≤ –º–∏—Ä–µ?\n‚Äî –ü–æ–º–Ω—é.\n‚Äî –ê –ø–æ—á–µ–º—É –∂–µ–Ω–∏–ª—Å—è –Ω–∞ –º–Ω–µ?\n‚Äî –ê —Ç—ã –≤–∏–¥–µ–ª–∞ —Ö–æ—Ç—å –æ–¥–Ω—É –¥–µ–≤—É—à–∫—É –∫—Ä–∞—Å–∏–≤–µ–µ —Ç–µ–±—è, –∫–æ—Ç–æ—Ä–∞—è —Å–æ–≥–ª–∞—Å–∏–ª–∞—Å—å –±—ã –∑–∞ –º–µ–Ω—è –≤—ã–π—Ç–∏?",

            "–ü—Ä–∏—Ö–æ–¥–∏—Ç –º—É–∂–∏–∫ –∫ –≤—Ä–∞—á—É:\n‚Äî –î–æ–∫—Ç–æ—Ä, —É –º–µ–Ω—è –ø—Ä–æ–±–ª–µ–º—ã —Å –ø–∞–º—è—Ç—å—é.\n‚Äî –ö–æ–≥–¥–∞ —ç—Ç–æ –Ω–∞—á–∞–ª–æ—Å—å?\n‚Äî –ß—Ç–æ –Ω–∞—á–∞–ª–æ—Å—å?",

            "–ó–≤–æ–Ω–æ–∫ –≤ —Å–ª—É–∂–±—É —Ç–∞–∫—Å–∏:\n‚Äî –ê–ª–ª–æ, –º–æ–∂–Ω–æ –º–∞—à–∏–Ω—É?\n‚Äî –ö—É–¥–∞?\n‚Äî –ù–∞ –¥–∞—á—É.\n‚Äî –ê –≥–¥–µ –¥–∞—á–∞?\n‚Äî –í –¥–µ—Ä–µ–≤–Ω–µ.\n‚Äî –ê –≥–¥–µ –¥–µ—Ä–µ–≤–Ω—è?\n‚Äî –ê –≤—ã —á—Ç–æ, –≥–µ–æ–≥—Ä–∞—Ñ–∏–∏ –Ω–µ –∑–Ω–∞–µ—Ç–µ?\n‚Äî –ó–Ω–∞—é.\n‚Äî –ù—É –≤–æ—Ç –∏ –µ–∑–∂–∞–π—Ç–µ!",

            "–†–∞–∑–≥–æ–≤–æ—Ä –¥–≤—É—Ö –ø–æ–¥—Ä—É–≥:\n‚Äî –ü—Ä–µ–¥—Å—Ç–∞–≤–ª—è–µ—à—å, –º–æ–π –º—É–∂ –ø–æ—Ö—É–¥–µ–ª –Ω–∞ 10 –∫–≥!\n‚Äî –ö–∞–∫?\n‚Äî –Ø –µ–≥–æ –≤—ã–≥–Ω–∞–ª–∞.",

            "–£—á–∏—Ç–µ–ª—å —Å–ø—Ä–∞—à–∏–≤–∞–µ—Ç –í–æ–≤–æ—á–∫—É:\n‚Äî –ï—Å–ª–∏ —É —Ç–≤–æ–µ–≥–æ –ø–∞–ø—ã –µ—Å—Ç—å 10 —è–±–ª–æ–∫, –∏ –æ–Ω –¥–∞—Å—Ç —Ç–µ–±–µ 3, —Å–∫–æ–ª—å–∫–æ —è–±–ª–æ–∫ —É —Ç–µ–±—è –±—É–¥–µ—Ç?\n‚Äî –ù–µ –∑–Ω–∞—é.\n‚Äî –ö–∞–∫ –Ω–µ –∑–Ω–∞–µ—à—å? 10 –º–∏–Ω—É—Å 3!\n‚Äî –ê –≤—ã –º–æ–µ–≥–æ –ø–∞–ø—É –Ω–µ –∑–Ω–∞–µ—Ç–µ!",

            "‚Äî –ú–∏–ª—ã–π, –∫—É–ø–∏ –º–Ω–µ —á—Ç–æ-–Ω–∏–±—É–¥—å —Å –±—Ä–∏–ª–ª–∏–∞–Ω—Ç–∞–º–∏!\n‚Äî –í–æ—Ç —Ç–µ–±–µ –∫–æ–ª–æ–¥–∞ –∫–∞—Ä—Ç.",

            "–ü–∞—Ü–∏–µ–Ω—Ç –∂–∞–ª—É–µ—Ç—Å—è –≤—Ä–∞—á—É:\n‚Äî –î–æ–∫—Ç–æ—Ä, —É –º–µ–Ω—è –æ—á–µ–Ω—å –ø–ª–æ—Ö–∞—è –ø–∞–º—è—Ç—å!\n‚Äî –ò –∫–æ–≥–¥–∞ –≤—ã —ç—Ç–æ –∑–∞–º–µ—Ç–∏–ª–∏?\n‚Äî –ß—Ç–æ –∑–∞–º–µ—Ç–∏–ª?",

            "‚Äî –î–æ—Ä–æ–≥–∞—è, —è –ø—Ä–∏–Ω—ë—Å —Ö–æ—Ä–æ—à–∏–µ –∏ –ø–ª–æ—Ö–∏–µ –Ω–æ–≤–æ—Å—Ç–∏.\n‚Äî –ù–∞—á–Ω–∏ —Å —Ö–æ—Ä–æ—à–∏—Ö.\n‚Äî Airbag –≤ –º–∞—à–∏–Ω–µ —Ä–∞–±–æ—Ç–∞–µ—Ç –æ—Ç–ª–∏—á–Ω–æ!",

            "–°–∏–¥–∏—Ç –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç, –∫–æ–¥–∏—Ç. –ñ–µ–Ω–∞ –∫—Ä–∏—á–∏—Ç:\n‚Äî –î–æ—Ä–æ–≥–æ–π, –≤—ã–Ω–µ—Å–∏ –º—É—Å–æ—Ä!\n‚Äî –ú–∏–Ω—É—Ç–æ—á–∫—É, –¥–æ–ø–∏—à—É —Ñ—É–Ω–∫—Ü–∏—é.\n–ß–µ—Ä–µ–∑ —á–∞—Å:\n‚Äî –î–æ—Ä–æ–≥–æ–π, —Ç—ã –º—É—Å–æ—Ä –≤—ã–Ω–µ—Å?\n‚Äî –î–∞, –≤ —Ñ—É–Ω–∫—Ü–∏—é –≤—ã–Ω–µ—Å.",

            "‚Äî –ü–æ—á–µ–º—É –ø—Ä–æ–≥—Ä–∞–º–º–∏—Å—Ç—ã –ø—É—Ç–∞—é—Ç –†–æ–∂–¥–µ—Å—Ç–≤–æ –∏ –•–µ–ª–ª–æ—É–∏–Ω?\n‚Äî –ü–æ—Ç–æ–º—É —á—Ç–æ 31 Oct = 25 Dec!",

            "–ñ–µ–Ω–∞ –≥–æ–≤–æ—Ä–∏—Ç –º—É–∂—É:\n‚Äî –î–æ—Ä–æ–≥–æ–π, –Ω–∞—à —Å—ã–Ω —Ç–∞–∫–æ–π –∂–µ, –∫–∞–∫ —Ç—ã!\n‚Äî –£–º–Ω—ã–π?\n‚Äî –ù–µ—Ç, –≤ —à–∞—Ö–º–∞—Ç—ã –∏–≥—Ä–∞—Ç—å –Ω–µ —É–º–µ–µ—Ç, –Ω–æ –≤—Å—ë —Ä–∞–≤–Ω–æ –ø–µ—Ä–µ–≤–æ—Ä–∞—á–∏–≤–∞–µ—Ç –¥–æ—Å–∫—É.",

            "‚Äî –î–æ–∫—Ç–æ—Ä, —É –º–µ–Ω—è —Å—Ç—Ä–∞–Ω–Ω–∞—è –±–æ–ª–µ–∑–Ω—å ‚Äî —è –ø–æ—Å—Ç–æ—è–Ω–Ω–æ –≤–∏–∂—É —Å–ø—Ä–∞–π—Ç—ã –∏ –∏–∫–æ–Ω–∫–∏!\n‚Äî –≠—Ç–æ –ø–∏–∫—Å–µ–ª—å–Ω–∞—è –ª–∏—Ö–æ—Ä–∞–¥–∫–∞. –ü–æ–ø–µ–π—Ç–µ —á–∞—é –≤ –Ω–∏–∑–∫–æ–º —Ä–∞–∑—Ä–µ—à–µ–Ω–∏–∏."
    );

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç —Å–ª—É—á–∞–π–Ω—ã–π –∞–Ω–µ–∫–¥–æ—Ç –∏–∑ –≤—Å–µ—Ö –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
     * @return —Ç–µ–∫—Å—Ç –∞–Ω–µ–∫–¥–æ—Ç–∞
     */
    public String getRandomJoke() {
        // –°–Ω–∞—á–∞–ª–∞ –ø—ã—Ç–∞–µ–º—Å—è –ø–æ–ª—É—á–∏—Ç—å –∏–∑ –≤–Ω–µ—à–Ω–∏—Ö API
        try {
            String externalJoke = getExternalJoke();
            if (externalJoke != null && !externalJoke.trim().isEmpty() && externalJoke.length() > 10) {
                logger.info("–ü–æ–ª—É—á–µ–Ω –∞–Ω–µ–∫–¥–æ—Ç –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ API");
                return externalJoke;
            }
        } catch (Exception e) {
            logger.warn("–û—à–∏–±–∫–∞ –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ –∞–Ω–µ–∫–¥–æ—Ç–∞ –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ –∏—Å—Ç–æ—á–Ω–∏–∫–∞: {}", e.getMessage());
        }

        // Fallback –Ω–∞ –ª–æ–∫–∞–ª—å–Ω—É—é –±–∞–∑—É
        String localJoke = getLocalJoke();
        logger.debug("–ò—Å–ø–æ–ª—å–∑–æ–≤–∞–Ω–∞ –ª–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –∞–Ω–µ–∫–¥–æ—Ç–æ–≤");
        return localJoke;
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç –∞–Ω–µ–∫–¥–æ—Ç –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑—ã
     * @return —Å–ª—É—á–∞–π–Ω—ã–π –∞–Ω–µ–∫–¥–æ—Ç –∏–∑ –ª–æ–∫–∞–ª—å–Ω–æ–π –∫–æ–ª–ª–µ–∫—Ü–∏–∏
     */
    private String getLocalJoke() {
        return localJokes.get(random.nextInt(localJokes.size()));
    }

    /**
     * –ü—ã—Ç–∞–µ—Ç—Å—è –ø–æ–ª—É—á–∏—Ç—å –∞–Ω–µ–∫–¥–æ—Ç –∏–∑ –≤–Ω–µ—à–Ω–∏—Ö –∏—Å—Ç–æ—á–Ω–∏–∫–æ–≤
     * @return —Ç–µ–∫—Å—Ç –∞–Ω–µ–∫–¥–æ—Ç–∞ –∏–ª–∏ null –≤ —Å–ª—É—á–∞–µ –æ—à–∏–±–∫–∏
     */
    private String getExternalJoke() {
        // –°–ø–∏—Å–æ–∫ —Ä—É—Å—Å–∫–æ—è–∑—ã—á–Ω—ã—Ö API (–≤ –ø–æ—Ä—è–¥–∫–µ –ø—Ä–∏–æ—Ä–∏—Ç–µ—Ç–∞)
        String[] apiUrls = {
                "http://rzhunemogu.ru/RandJSON.aspx?CType=1"  // RzhuneMogu.ru API
        };

        for (String apiUrl : apiUrls) {
            try {
                String joke = fetchJokeFromApi(apiUrl);
                if (joke != null && !joke.trim().isEmpty()) {
                    logger.debug("–ü–æ–ª—É—á–µ–Ω –∞–Ω–µ–∫–¥–æ—Ç –∏–∑ –≤–Ω–µ—à–Ω–µ–≥–æ API: {}", apiUrl);
                    return joke;
                }
            } catch (Exception e) {
                logger.debug("–û—à–∏–±–∫–∞ –ø—Ä–∏ –æ–±—Ä–∞—â–µ–Ω–∏–∏ –∫ API {}: {}", apiUrl, e.getMessage());
            }
        }

        return null;
    }

    /**
     * –í—ã–ø–æ–ª–Ω—è–µ—Ç HTTP-–∑–∞–ø—Ä–æ—Å –∫ API –¥–ª—è –ø–æ–ª—É—á–µ–Ω–∏—è –∞–Ω–µ–∫–¥–æ—Ç–∞
     * @param apiUrl URL API
     * @return —Ç–µ–∫—Å—Ç –∞–Ω–µ–∫–¥–æ—Ç–∞ –∏–ª–∏ null
     */
    private String fetchJokeFromApi(String apiUrl) {
        try {
            URL url = new URL(apiUrl);
            HttpURLConnection connection = (HttpURLConnection) url.openConnection();
            connection.setRequestMethod("GET");
            connection.setRequestProperty("Accept", "application/json");
            connection.setRequestProperty("User-Agent", "Mozilla/5.0 (TelegramBot/1.0)");
            connection.setConnectTimeout(3000); // 3 —Å–µ–∫—É–Ω–¥—ã
            connection.setReadTimeout(3000);

            int responseCode = connection.getResponseCode();
            if (responseCode == HttpURLConnection.HTTP_OK) {
                // –ß–∏—Ç–∞–µ–º —Å –ø—Ä–∞–≤–∏–ª—å–Ω–æ–π –∫–æ–¥–∏—Ä–æ–≤–∫–æ–π –¥–ª—è —Ä—É—Å—Å–∫–æ–≥–æ —Ç–µ–∫—Å—Ç–∞
                try (BufferedReader reader = new BufferedReader(
                        new InputStreamReader(connection.getInputStream(), StandardCharsets.UTF_8))) {

                    StringBuilder response = new StringBuilder();
                    String line;
                    while ((line = reader.readLine()) != null) {
                        response.append(line);
                    }

                    return parseJokeResponse(response.toString(), apiUrl);
                }
            } else {
                logger.warn("HTTP {} –æ—Ç API: {}", responseCode, apiUrl);
            }
        } catch (Exception e) {
            logger.warn("–û—à–∏–±–∫–∞ –ø—Ä–∏ –∑–∞–ø—Ä–æ—Å–µ –∫ API {}: {}", apiUrl, e.getMessage());
        }

        return null;
    }

    /**
     * –ü–∞—Ä—Å–∏—Ç –æ—Ç–≤–µ—Ç –æ—Ç API –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –µ–≥–æ —Ñ–æ—Ä–º–∞—Ç–∞
     * @param response –æ—Ç–≤–µ—Ç –æ—Ç API
     * @param apiUrl URL –∏—Å—Ç–æ—á–Ω–∏–∫–∞
     * @return —Ä–∞—Å–ø–∞—Ä—Å–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç –∞–Ω–µ–∫–¥–æ—Ç–∞
     */
    private String parseJokeResponse(String response, String apiUrl) {
        try {
            if (apiUrl.contains("rzhunemogu.ru")) {
                // –ü–∞—Ä—Å–∏–º RzhuneMogu: {"content":"—Ç–µ–∫—Å—Ç –∞–Ω–µ–∫–¥–æ—Ç–∞"}
                String content = extractJsonValue(response, "content");
                if (content != null && content.length() > 10) {
                    // –û—á–∏—â–∞–µ–º HTML —Ç–µ–≥–∏ –∏ –ª–∏—à–Ω–∏–µ —Å–∏–º–≤–æ–ª—ã
                    return cleanJokeText(content);
                }
            }
        } catch (Exception e) {
            logger.warn("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ –æ—Ç–≤–µ—Ç–∞ –æ—Ç {}: {}", apiUrl, e.getMessage());
        }

        return null;
    }

    /**
     * –û—á–∏—â–∞–µ—Ç —Ç–µ–∫—Å—Ç –∞–Ω–µ–∫–¥–æ—Ç–∞ –æ—Ç HTML —Ç–µ–≥–æ–≤ –∏ –Ω–æ—Ä–º–∞–ª–∏–∑—É–µ—Ç
     * @param text –∏—Å—Ö–æ–¥–Ω—ã–π —Ç–µ–∫—Å—Ç
     * @return –æ—á–∏—â–µ–Ω–Ω—ã–π —Ç–µ–∫—Å—Ç
     */
    private String cleanJokeText(String text) {
        if (text == null) return null;

        return text
                .replaceAll("<[^>]*>", "") // –£–¥–∞–ª—è–µ–º HTML —Ç–µ–≥–∏
                .replaceAll("&quot;", "\"") // –î–µ–∫–æ–¥–∏—Ä—É–µ–º –∫–∞–≤—ã—á–∫–∏
                .replaceAll("&amp;", "&")   // –î–µ–∫–æ–¥–∏—Ä—É–µ–º –∞–º–ø–µ—Ä—Å–∞–Ω–¥
                .replaceAll("&lt;", "<")    // –î–µ–∫–æ–¥–∏—Ä—É–µ–º <
                .replaceAll("&gt;", ">")    // –î–µ–∫–æ–¥–∏—Ä—É–µ–º >
                .replaceAll("\\\\n", "\n")  // –ù–æ—Ä–º–∞–ª–∏–∑—É–µ–º –ø–µ—Ä–µ–≤–æ–¥—ã —Å—Ç—Ä–æ–∫
                .replaceAll("\\\\r", "")    // –£–¥–∞–ª—è–µ–º \\r
                .replaceAll("\\\\t", " ")   // –ó–∞–º–µ–Ω—è–µ–º —Ç–∞–±—ã –Ω–∞ –ø—Ä–æ–±–µ–ª—ã
                .replaceAll("\\s+", " ")    // –£–±–∏—Ä–∞–µ–º –ª–∏—à–Ω–∏–µ –ø—Ä–æ–±–µ–ª—ã
                .trim();
    }

    /**
     * –ü—Ä–æ—Å—Ç–æ–π –ø–∞—Ä—Å–µ—Ä –¥–ª—è –∏–∑–≤–ª–µ—á–µ–Ω–∏—è –∑–Ω–∞—á–µ–Ω–∏–π –∏–∑ JSON
     * @param json JSON —Å—Ç—Ä–æ–∫–∞
     * @param key –∫–ª—é—á –¥–ª—è –ø–æ–∏—Å–∫–∞
     * @return –∑–Ω–∞—á–µ–Ω–∏–µ –∏–ª–∏ null
     */
    private String extractJsonValue(String json, String key) {
        try {
            String searchPattern = "\"" + key + "\":\"";
            int startIndex = json.indexOf(searchPattern);
            if (startIndex == -1) {
                return null;
            }

            startIndex += searchPattern.length();
            int endIndex = json.indexOf("\"", startIndex);

            // –û–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ–º escaped –∫–∞–≤—ã—á–∫–∏
            while (endIndex > 0 && json.charAt(endIndex - 1) == '\\') {
                endIndex = json.indexOf("\"", endIndex + 1);
            }

            if (endIndex == -1) {
                return null;
            }

            return json.substring(startIndex, endIndex);
        } catch (Exception e) {
            logger.warn("–û—à–∏–±–∫–∞ –ø–∞—Ä—Å–∏–Ω–≥–∞ JSON: {}", e.getMessage());
            return null;
        }
    }

    /**
     * –ü—Ä–æ–≤–µ—Ä—è–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å —Å–µ—Ä–≤–∏—Å–∞ –∞–Ω–µ–∫–¥–æ—Ç–æ–≤
     * @return true –µ—Å–ª–∏ —Å–µ—Ä–≤–∏—Å —Ä–∞–±–æ—Ç–∞–µ—Ç
     */
    public boolean isServiceAvailable() {
        return true; // –õ–æ–∫–∞–ª—å–Ω–∞—è –±–∞–∑–∞ –≤—Å–µ–≥–¥–∞ –¥–æ—Å—Ç—É–ø–Ω–∞
    }

    /**
     * –ü–æ–ª—É—á–∞–µ—Ç —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∞–Ω–µ–∫–¥–æ—Ç–æ–≤
     * @return –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –æ –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –∞–Ω–µ–∫–¥–æ—Ç–∞—Ö
     */
    public String getJokeStats() {
        int localCount = localJokes.size();
        boolean apiAvailable = testExternalApi();

        if (apiAvailable) {
            return String.format("üìä –î–æ—Å—Ç—É–ø–Ω–æ %d –ª–æ–∫–∞–ª—å–Ω—ã—Ö –∞–Ω–µ–∫–¥–æ—Ç–æ–≤ + —Ç—ã—Å—è—á–∏ –∏–∑ –≤–Ω–µ—à–Ω–∏—Ö API", localCount);
        } else {
            return String.format("üìä –î–æ—Å—Ç—É–ø–Ω–æ %d —Ä—É—Å—Å–∫–∏—Ö –∞–Ω–µ–∫–¥–æ—Ç–æ–≤ –≤ –ª–æ–∫–∞–ª—å–Ω–æ–π –±–∞–∑–µ", localCount);
        }
    }

    /**
     * –¢–µ—Å—Ç–∏—Ä—É–µ—Ç –¥–æ—Å—Ç—É–ø–Ω–æ—Å—Ç—å –≤–Ω–µ—à–Ω–∏—Ö API
     * @return true –µ—Å–ª–∏ —Ö–æ—Ç—è –±—ã –æ–¥–∏–Ω API –¥–æ—Å—Ç—É–ø–µ–Ω
     */
    private boolean testExternalApi() {
        try {
            String testJoke = getExternalJoke();
            return testJoke != null && !testJoke.trim().isEmpty();
        } catch (Exception e) {
            return false;
        }
    }
}